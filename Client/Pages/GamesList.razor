@page "/GamesList/"
@using template.Shared.Models.Games
@inject HttpClient Http
@inject NavigationManager Nav


<PageTitle>המשחקים שלי</PageTitle>

<ImageWithText_EmptySign Text="המשחקים שלי" />

<h1 class="text-danger">המשתמש שמחובר כעת: @UserId</h1>

<div class="d-flex flex-row justify-content-end">
    <button class="btn btn-danger fa fa-plus" @onclick="NavigateToAddGame">
        יצירת משחק חדש
    </button>
</div>
<br />


@if (MyGamesList != null)
{
    <div class="table-container">
        <table class="table table-sm">
            <thead>
                <tr>
                    <th>שם המשחק</th>
                    <th>קוד המשחק</th>
                    <th>מספר שאלות</th>
                    <th>עריכה</th>
                    <th>מחיקה</th>
                    <th>פרסום</th>
                </tr>
            </thead>
            <tbody>
                @foreach (GameToTable game in MyGamesList)
                {
                    <tr>
                        <td>@game.GameName</td>
                        <td>@game.GameCode</td>
                        <td>@game.NumQuestion</td>
                        <td class="table-buttons">
                            <button class="edit-btn" @onclick="() => EditGame(game.ID)"></button>
                        </td>
                        <td class="table-buttons">
                            <button class="delete-btn" @onclick="() => DeleteGame(game.ID)"></button>
                        </td>
                        <td>
                            <label class="switch">
                                <input type="checkbox" checked="@game.IsPublish" @onchange="@(e => TogglePublish(game.ID, ((ChangeEventArgs)e).Value.ToString().ToLower() == "true"))" disabled="@(IsPublishDisabled(game.NumQuestion))" />
                                <span class="slider"></span>
                            </label>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}


@if (msg != "")
{
    <p class="msg">@msg</p>
    <input type="button" value="reload" @onclick=Navigate />
}

@code {
    [CascadingParameter]
    public int UserId { get; set; }

    List<GameToTable> MyGamesList;
    string msg = "";

    protected override async Task OnInitializedAsync()
    {
        var gamesRes = await Http.GetAsync("api/games/");

        if (gamesRes.IsSuccessStatusCode)
        {
            MyGamesList = await gamesRes.Content.ReadFromJsonAsync<List<GameToTable>>();
        }
        else
        {
            string error = await gamesRes.Content.ReadAsStringAsync();
            ShowError(error);
        }
    }

    void Navigate()
    {
        Nav.NavigateTo("./", true);
    }

    void NavigateToAddGame()
    {
        Nav.NavigateTo("/AddGame");
    }

    void EditGame(int gameId)
    {
        Nav.NavigateTo($"/AddGame/{gameId}");
    }

    async Task DeleteGame(int gameId)
    {
        var response = await Http.DeleteAsync($"api/games/{gameId}");

        if (response.IsSuccessStatusCode)
        {
            MyGamesList = MyGamesList.Where(g => g.ID != gameId).ToList();
        }
        else
        {
            string error = await response.Content.ReadAsStringAsync();
            ShowError(error);
        }
    }

    async Task TogglePublish(int gameId, bool isPublish)
    {
        var response = await Http.PostAsJsonAsync("api/games/publishGame", new PublishGame { ID = gameId, IsPublish = isPublish });

        if (response.IsSuccessStatusCode)
        {
            var game = MyGamesList.FirstOrDefault(g => g.ID == gameId);
            if (game != null)
            {
                game.IsPublish = isPublish;
                game.CanPublish = isPublish;
            }
        }
        else
        {
            string error = await response.Content.ReadAsStringAsync();
            ShowError(error);
        }
    }

    bool IsPublishDisabled(int numQuestion)
    {
        return !(numQuestion >= 10 && numQuestion % 2 == 0);
    }

    void ShowError(string error)
    {
        switch (error)
        {
            case "No games for this user":
                msg = "עדין לא יצרת משחקים... זה הזמן ליצור את הראשון :)";
                break;
            case "user is not authenticated":
                msg = "ארעה בעיה בעת אימות המשתמש";
                break;
            case "Game not created":
                msg = "ארעה בעיה בעת יצירת המשחק";
                break;
            case "Game code not created":
                msg = "ארעה בעיה בעת יצירת קוד המשחק";
                break;
            case "This game cannot be published":
                msg = "המשחק אינו מאושר לפרסום";
                break;
            case "Update Failed":
                msg = "עדכון המשחק נכשל";
                break;
            case "It's Not Your Game":
                msg = "המשחק אינו שייך לך";
                break;
            case "Failed to create the new game":
                msg = "נכשל ביצירת המשחק החדש";
                break;
            default:
                msg = "שגיאה לא ידועה";
                break;
        }
    }
}